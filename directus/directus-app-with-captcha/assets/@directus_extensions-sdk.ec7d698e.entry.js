import{i as j,r as w,c as s,f as X,u as y,d as D,g as H,t as z}from"./runtime-core.esm-bundler.15edf3c4.js";import{l as A,a as N}from"./index.cb9b3c3b.js";function de(e){return e}function fe(e){return e}function ve(e){return e}function pe(e){return e}function me(e){return e}function _e(e){return e}function ye(e){return e}function he(e){return e}function ge(e){return e}function Se(e){if(e===null)return[];const t=/{{(.*?)}}/g;let l=e.match(t);return Array.isArray(l)?(l=l.map(u=>u.replace(/{{/g,"").replace(/}}/g,"").trim()),l):[]}function Fe(e){var t,l,u;const{relation:n,collection:i,field:a}=e;return n?n.collection===i&&n.field===a&&((t=n.meta)===null||t===void 0?void 0:t.one_collection_field)&&((l=n.meta)===null||l===void 0?void 0:l.one_allowed_collections)?"m2a":n.collection===i&&n.field===a?"m2o":n.related_collection===i&&((u=n.meta)===null||u===void 0?void 0:u.one_field)===a?"o2m":null:null}function K(e,t,l){const u=e[t],n=e.length,i=t-l;if(u===void 0)return e;if(i>0)return[...e.slice(0,l),u,...e.slice(l,t),...e.slice(t+1,n)];if(i<0){const a=l+1;return[...e.slice(0,t),...e.slice(t+1,a),u,...e.slice(a,n)]}return e}const V="stores",Y="api",Z="extensions";function ee(){const e=j(V);if(!e)throw new Error("[useStores]: The stores could not be found.");return e}function te(){const e=j(Y);if(!e)throw new Error("[useApi]: The api could not be found.");return e}function ne(){const e=j(Z);if(!e)throw new Error("[useExtensions]: The extensions could not be found.");return e}function le(e){const{useCollectionsStore:t,useFieldsStore:l}=ee(),u=t(),n=l(),i=typeof e=="string"?w(e):e,a=s(()=>u.collections.find(({collection:o})=>o===i.value)||null),m=s(()=>i.value?n.getFieldsForCollectionSorted(i.value):[]),T=s(()=>{var o;if(!m.value)return{};const r={};for(const c of m.value)!((o=c.schema)===null||o===void 0)&&o.default_value&&(r[c.field]=c.schema.default_value);return r}),E=s(()=>m.value.find(o=>{var r;return o.collection===i.value&&((r=o.schema)===null||r===void 0?void 0:r.is_primary_key)===!0})||null),$=s(()=>{var o;return((o=m.value)===null||o===void 0?void 0:o.find(r=>{var c;return(((c=r.meta)===null||c===void 0?void 0:c.special)||[]).includes("user_created")}))||null}),_=s(()=>{var o,r;return((r=(o=a.value)===null||o===void 0?void 0:o.meta)===null||r===void 0?void 0:r.sort_field)||null}),C=s(()=>{var o,r;return((r=(o=a.value)===null||o===void 0?void 0:o.meta)===null||r===void 0?void 0:r.singleton)===!0}),h=s(()=>!a.value||!a.value.meta?null:a.value.meta.accountability);return{info:a,fields:m,defaults:T,primaryKeyField:E,userCreatedField:$,sortField:_,isSingleton:C,accountabilityScope:h}}function be(e,t){return{fieldGroups:s(()=>{const u={};for(const n in t)u[n]=[];return e.value.reduce((n,i)=>{for(const a in t)t[a](i)!==!1&&n[a].push(i);return n},u)})}}function we(e,t,l=!0){const u=te(),{primaryKeyField:n}=le(e),{fields:i,alias:a,limit:m,sort:T,search:E,filter:$,page:_}=t,C=s(()=>e.value?e.value.startsWith("directus_")?`/${e.value.substring(9)}`:`/items/${e.value}`:null),h=w([]),o=w(!1),r=w(null),c=w(null),I=w(null),M=s(()=>{var f,v;return c.value===null||c.value<((f=y(m))!==null&&f!==void 0?f:100)?1:Math.ceil(c.value/((v=y(m))!==null&&v!==void 0?v:100))});let S=null,F=null;const k=A.exports.throttle(x,500);return l&&k(),X([e,m,T,E,$,i,_],async(f,v)=>{if(A.exports.isEqual(f,v))return;const[p,d,g,b,P,O,oe]=f,[L,J,U,G,Q,re,ae]=v;!p||!t||((!A.exports.isEqual(P,Q)||!A.exports.isEqual(g,U)||d!==J||b!==G)&&L&&(_.value=1),p!==L&&q(),k())},{deep:!0,immediate:!0}),{itemCount:c,totalCount:I,items:h,totalPages:M,loading:o,error:r,changeManualSort:B,getItems:x};async function x(){var f,v;if(!C.value)return;S==null||S.cancel(),S=null,r.value=null,F&&clearTimeout(F),F=setTimeout(()=>{o.value=!0},150);let p=[...(f=y(i))!==null&&f!==void 0?f:[]];!(!((v=y(i))===null||v===void 0)&&v.includes("*"))&&n.value&&p.includes(n.value.field)===!1&&p.push(n.value.field),p=p.filter(d=>d.startsWith("$")===!1);try{S=N.CancelToken.source();const d=await u.get(C.value,{params:{limit:y(m),fields:p,...a?{alias:y(a)}:{},sort:y(T),page:y(_),search:y(E),filter:y($),meta:["filter_count","total_count"]},cancelToken:S.token});let g=d.data.data;e.value==="directus_files"&&(g=g.map(b=>({...b,$thumbnail:b}))),h.value=g,I.value=d.data.meta.total_count,c.value=d.data.meta.filter_count,_&&g.length===0&&(_==null?void 0:_.value)!==1&&(_.value=1)}catch(d){N.isCancel(d)||(r.value=d)}finally{F&&(clearTimeout(F),F=null),o.value=!1}}function q(){h.value=[],I.value=null,c.value=null}async function B({item:f,to:v}){var p;const d=(p=n.value)===null||p===void 0?void 0:p.field;if(!d)return;const g=h.value.findIndex(O=>O[d]===f),b=h.value.findIndex(O=>O[d]===v);h.value=K(h.value,g,b);const P=s(()=>`/utils/sort/${e.value}`);await u.post(P.value,{item:f,to:v})}}const W="wrapper",R=["selection","layoutOptions","layoutQuery"];function ue(e){return R.includes(e)}function ie(e){return D({name:`${e.id}-${W}`,props:{collection:{type:String,required:!0},selection:{type:Array,default:()=>[]},layoutOptions:{type:Object,default:()=>({})},layoutQuery:{type:Object,default:()=>({})},filter:{type:Object,default:null},filterUser:{type:Object,default:null},filterSystem:{type:Object,default:null},search:{type:String,default:null},showSelect:{type:String,default:"multiple"},selectMode:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},resetPreset:{type:Function,default:null},clearFilters:{type:Function,default:null}},emits:R.map(t=>`update:${t}`),setup(t,{emit:l}){const u=H({...e.setup(t,{emit:l}),...z(t)});for(const n in u)u[`onUpdate:${n}`]=i=>{ue(n)?l(`update:${n}`,i):Object.keys(t).includes(n)||(u[n]=i)};return{state:u}},render(t){return t.$slots.default!==void 0?t.$slots.default({layoutState:t.state}):null}})}function Te(e){const{layouts:t}=ne(),l=s(()=>t.value.map(n=>ie(n)));return{layoutWrapper:s(()=>{const n=l.value.find(i=>i.name===`${e.value}-${W}`);return n===void 0?l.value.find(i=>i.name===`tabular-${W}`):n})}}function Ee(e,t,l){return s({get(){return e[t]},set(u){l(`update:${t}`,u)}})}export{fe as defineDisplay,ye as defineEndpoint,_e as defineHook,de as defineInterface,ve as defineLayout,pe as defineModule,ge as defineOperationApi,he as defineOperationApp,me as definePanel,Se as getFieldsFromTemplate,Fe as getRelationType,te as useApi,le as useCollection,ne as useExtensions,be as useFilterFields,we as useItems,Te as useLayout,ee as useStores,Ee as useSync};
